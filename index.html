<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tetris 3D Interactive ‚Äî Neon Space</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-1: #030313;
    --panel-1: rgba(8,10,20,0.55);
    --accent-1: #4de3ff;
    --accent-2: #8b5cff;
    --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02);
    --muted: #9fb0c7;
  }
  html,body{height:100%;margin:0;background: radial-gradient(ellipse at 30% 10%, #071028 0%, #02030b 40%, #000006 100%);font-family:Inter, system-ui, Arial;color:#e6f4ff;overflow:hidden}
  /* page layout */
  .app{
    height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;padding:22px;box-sizing:border-box;
    perspective:1400px;
  }
  header{display:flex;align-items:center;gap:18px;width:100%;max-width:1200px}
  .logo{
    display:flex;flex-direction:column;gap:2px;
    transform:translateZ(40px) rotateX(6deg);
  }
  .logo h1{font-family:Orbitron, monospace;margin:0;font-size:22px;letter-spacing:1px;color:var(--accent-1);text-shadow:0 0 12px rgba(77,227,255,0.12)}
  .logo p{margin:0;font-size:12px;color:var(--muted)}
  .top-controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{background:linear-gradient(180deg,var(--panel-1),#041025);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:#dff6ff;cursor:pointer;backdrop-filter:blur(6px);box-shadow:0 6px 20px rgba(0,0,0,0.6)}
  .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.04)}
  /* main area */
  .main{
    display:flex;gap:22px;width:100%;max-width:1200px;align-items:flex-start;transform:translateZ(20px);
  }

  /* left: dynamic background canvas & floating 3D container */
  .stage{
    width:680px;height:720px;position:relative;overflow:visible;
    display:flex;align-items:center;justify-content:center;
  }

  /* starfield background */
  canvas#bg{position:absolute;left:0;top:0;width:100%;height:100%;border-radius:14px;filter:blur(0.6px);}

  /* 3d container holding tetris board */
  .board-wrap{
    width:360px;height:720px;transform-style:preserve-3d;transition:transform 0.4s cubic-bezier(.2,.9,.3,1);pointer-events:auto;
    transform-origin:center center;
  }
  .board-wrap:hover{transform:rotateX(8deg) rotateY(6deg) translateZ(40px) scale(1.02)}
  .board-shell{
    width:360px;height:720px;padding:18px;background:linear-gradient(180deg, rgba(6,12,26,0.7), rgba(2,4,10,0.6));border-radius:14px;border:1px solid rgba(125,170,255,0.06);box-shadow:0 30px 80px rgba(2,6,18,0.7), inset 0 0 40px rgba(75,120,255,0.02);
    display:flex;flex-direction:column;align-items:center;gap:12px;
    position:relative;overflow:hidden;
  }
  .board-bezel{
    width:320px;height:680px;background:linear-gradient(180deg, rgba(12,20,35,0.45), rgba(6,8,16,0.35));border-radius:10px;padding:8px;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);
    box-shadow: inset 0 0 24px rgba(0,0,0,0.7);
  }

  /* tetris canvas */
  canvas#tetris{width:280px;height:560px;background:linear-gradient(180deg,#040617,#011022);border:3px solid rgba(125,200,255,0.12);box-shadow:0 10px 40px rgba(40,140,255,0.03) inset, 0 0 40px rgba(0,120,220,0.06);border-radius:8px;display:block; image-rendering:pixelated}

  /* right: HUD */
  .hud{
    width:420px;display:flex;flex-direction:column;gap:14px;
    transform:translateZ(40px);
  }
  .panel{
    background:linear-gradient(180deg, rgba(10,12,20,0.45), rgba(5,6,12,0.35));
    border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 40px rgba(2,6,15,0.6);
    backdrop-filter: blur(6px);
  }
  .panel h3{margin:0 0 8px 0;font-size:14px;color:var(--accent-2)}
  .stats{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .stat{display:flex;flex-direction:column;align-items:center;gap:6px;flex:1;padding:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:8px}
  .stat .num{font-size:20px;font-weight:700;color:var(--accent-1)}
  .controls-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .small{font-size:12px;color:var(--muted)}

  /* next & hold */
  .next-hold{display:flex;gap:10px;align-items:center}
  .mini-canvas{width:112px;height:112px;border-radius:8px;background:linear-gradient(180deg,#02111a,#00121a);border:1px solid rgba(255,255,255,0.03);display:block;box-shadow:inset 0 0 18px rgba(0,0,0,0.6)}
  .label{font-size:12px;color:var(--muted);margin-bottom:6px}

  /* leaderboard */
  .leaderboard-list{max-height:160px;overflow:auto;padding-right:6px}
  .leaderboard-item{display:flex;justify-content:space-between;padding:8px;border-radius:8px;margin-bottom:6px;background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent)}
  .controls-row{display:flex;gap:8px;align-items:center}

  /* bottom hints */
  .hints{font-size:12px;color:#9fb0c9;opacity:0.9}

  /* fancy neon glows */
  .neon-title{font-family:Orbitron, monospace;font-weight:700;font-size:18px;color:var(--accent-1);text-shadow:0 0 10px rgba(77,227,255,0.12)}
  .glow{box-shadow:0 10px 30px rgba(77,227,255,0.06);border:1px solid rgba(77,227,255,0.03)}

  /* responsive */
  @media (max-width:1100px){ .main{flex-direction:column;align-items:center} .stage, .hud{width:100%;max-width:720px} .board-wrap{transform:none} }
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="logo">
      <h1>TETRIS 3D ‚Ä¢ NEON SPACE</h1>
      <p>Interactive UI ‚Ä¢ 3D Perspective ‚Ä¢ Leaderboard Lokal</p>
    </div>

    <div class="top-controls">
      <button class="btn" id="btn-help">Controls</button>
      <button class="btn" id="btn-screenshot">üì∏ Screenshot</button>
      <button class="btn" id="btn-restart-header">üîÅ Restart</button>
    </div>
  </header>

  <div class="main">
    <!-- stage with starfield and 3d board -->
    <div class="stage">
      <canvas id="bg"></canvas>

      <div class="board-wrap" id="boardWrap">
        <div class="board-shell">
          <div class="board-bezel glow">
            <canvas id="tetris"></canvas>
          </div>
          <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
            <div class="label small">Hold</div>
            <canvas id="hold" class="mini-canvas"></canvas>
            <div style="width:18px"></div>
            <div class="label small">Next</div>
            <canvas id="next" class="mini-canvas"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- HUD -->
    <aside class="hud">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="neon-title">STATUS</div>
            <div class="small">Mode: <strong id="modeLabel">Classic 3D</strong></div>
          </div>
          <div style="text-align:right">
            <div class="small">Player</div>
            <div style="font-weight:700">Guest</div>
          </div>
        </div>

        <div class="stats" style="margin-top:10px">
          <div class="stat">
            <div class="small">Skor</div>
            <div class="num" id="score">0</div>
          </div>
          <div class="stat">
            <div class="small">Level</div>
            <div class="num" id="level">1</div>
          </div>
          <div class="stat">
            <div class="small">Baris</div>
            <div class="num" id="lines">0</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" id="btn-pause">‚è∏ Pause</button>
          <button class="btn" id="btn-hold">‚áÖ Hold</button>
          <button class="btn" id="btn-music">üéµ Music</button>
        </div>

        <div style="margin-top:10px" class="small hints">Tips: Gunakan ‚Üê ‚Üí untuk geser, ‚Üë rotasi, ‚Üì soft drop, Space hard drop, Shift turbo, P pause.</div>
      </div>

      <div class="panel">
        <h3>Leaderboard Lokal</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="playerName" placeholder="Nama (max 12)" maxlength="12" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#eaf6ff" />
          <button class="btn" id="btn-save">üíæ Simpan</button>
        </div>
        <div class="leaderboard-list panel-list" id="leaderboard">
          <!-- items -->
        </div>
        <div class="small" style="margin-top:8px;color:var(--muted)">Leaderboard disimpan di browser (localStorage).</div>
      </div>

      <div class="panel">
        <h3>Advanced</h3>
        <div style="display:flex;flex-direction:column;gap:8px">
          <label class="small">Volume</label>
          <input id="volume" type="range" min="0" max="1" step="0.01" value="0.4" />
          <label class="small">Visual Depth</label>
          <input id="depth" type="range" min="-30" max="120" step="1" value="40" />
          <div style="display:flex;gap:8px;margin-top:6px">
            <button class="btn ghost" id="btn-toggle-challenge">Toggle Challenge</button>
            <button class="btn ghost" id="btn-clear-lb">Clear LB</button>
          </div>
        </div>
      </div>

    </aside>
  </div>

  <footer style="position:fixed;bottom:10px;left:50%;transform:translateX(-50%);font-size:12px;color:#9fb0c7;opacity:0.9">
    Built 2025 ‚Äî Tetris 3D Interactive ‚Ä¢ Ekskul Coding
  </footer>
</div>

<!-- Help modal (simple) -->
<div id="helpModal" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(0.8);background:linear-gradient(180deg,#061022,#021018);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 30px 90px rgba(0,0,0,0.8);display:none;z-index:9999">
  <h3 style="margin:0 0 8px;color:var(--accent-2)">Kontrol</h3>
  <div style="font-size:13px;color:var(--muted);line-height:1.6">
    ‚Üê ‚Üí : Geser<br>‚Üë : Rotasi<br>‚Üì : Soft drop<br>Space : Hard drop<br>Shift : Turbo (fast drop while ditekan)<br>P : Pause / Resume<br>
    Klik Restart untuk memulai ulang. Simpan skor agar tampil di leaderboard lokal.
  </div>
  <div style="text-align:right;margin-top:10px"><button class="btn" id="helpClose">Tutup</button></div>
</div>

<script>
/* =========================
   Game configuration & setup
   ========================= */
const canvas = document.getElementById('tetris');
const ctx = canvas.getContext('2d', { alpha: true });
const nextCan = document.getElementById('next');
const nextCtx = nextCan.getContext('2d');
const holdCan = document.getElementById('hold');
const holdCtx = holdCan.getContext('2d');
const bgCanvas = document.getElementById('bg');
const bgCtx = bgCanvas.getContext('2d');

const COLS = 10, ROWS = 20, CELL = 28;
canvas.width = COLS * CELL;
canvas.height = ROWS * CELL;
nextCan.width = 4 * 28; nextCan.height = 4 * 28;
holdCan.width = 4 * 28; holdCan.height = 4 * 28;
bgCanvas.width = document.querySelector('.stage').clientWidth;
bgCanvas.height = document.querySelector('.stage').clientHeight;

let volumeControl = document.getElementById('volume');
let visualDepth = document.getElementById('depth');

/* dynamic style for board depth (3D feel) */
function applyDepth(){
  const d = parseInt(visualDepth.value,10);
  document.getElementById('boardWrap').style.transform = `translateZ(${d}px) rotateX(${Math.max(0, d/8)}deg)`;
}
applyDepth();
visualDepth.addEventListener('input', applyDepth);

/* colors (neon palette) */
const baseColors = [null, '#00f0ff', '#8b5cff', '#ffd166', '#7cffb2', '#ff6b6b', '#ff8fb1', '#ffffff'];
function levelColor(i, lvl){
  // subtle brightness increase with level
  const c = baseColors[i] || '#888';
  // return c for now (could tint by level)
  return c;
}

/* shapes */
const SHAPES = {
  I: [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],
  O: [[2,2],[2,2]],
  T: [[0,3,0],[3,3,3],[0,0,0]],
  S: [[0,4,4],[4,4,0],[0,0,0]],
  Z: [[5,5,0],[0,5,5],[0,0,0]],
  J: [[6,0,0],[6,6,6],[0,0,0]],
  L: [[0,0,7],[7,7,7],[0,0,0]]
};
const PIECES = Object.keys(SHAPES);

/* game state */
let arena = createMatrix(COLS, ROWS);
let player = { pos: {x:0,y:0}, matrix: null, hold: null, canHold: true };
let nextQueue = [];
let dropCounter = 0;
let dropInterval = 1000;
let lastTime = 0;
let running = true;
let paused = false;
let score = 0, lines = 0, level = 1;
let highscore = parseInt(localStorage.getItem('tetris3d_high')||'0',10) || 0;
let music, sfxHold, sfxClear, sfxLock;
let challengeEnabled = false;
let challengeTimer = 0;

/* particles for explosion and ambient */
let particles = [];

/* audio setup: simple Audio objects (no external libs) */
function initAudio(){
  try{
    music = new Audio('https://cdn.pixabay.com/download/audio/2022/03/10/audio_d1fdf73e48.mp3?filename=retro-game-music-11077.mp3');
    music.loop = true; music.volume = parseFloat(volumeControl.value);
    sfxHold = new Audio('https://cdn.pixabay.com/download/audio/2022/03/31/audio_9e4b05a6cd.mp3?filename=line-clear.mp3');
    sfxLock = new Audio('https://cdn.pixabay.com/download/audio/2022/03/10/audio_ke1d3f6e27.mp3?filename=ui-click-5401.mp3');
    sfxClear = new Audio('https://cdn.pixabay.com/download/audio/2022/03/31/audio_9e4b05a6cd.mp3?filename=line-clear.mp3');
    sfxHold.volume = sfxLock.volume = sfxClear.volume = parseFloat(volumeControl.value);
  }catch(e){
    music = null;
  }
}
initAudio();

/* ---------- helper functions ---------- */
function createMatrix(w,h){ const m=[]; while(h--) m.push(new Array(w).fill(0)); return m; }
function randomPiece(){ const k = PIECES[Math.floor(Math.random()*PIECES.length)]; return SHAPES[k].map(r=>r.slice()); }
function merge(arenaRef, piece){
  piece.matrix.forEach((row,y)=> row.forEach((val,x) => {
    if(val) arenaRef[y + piece.pos.y][x + piece.pos.x] = val;
  }));
  if(sfxLock) try{ sfxLock.currentTime=0; sfxLock.play(); }catch(e){}
}
function collide(arenaRef, piece){
  const m = piece.matrix;
  for(let y=0;y<m.length;y++){
    for(let x=0;x<m[y].length;x++){
      if(m[y][x]){
        const ay = arenaRef[y + piece.pos.y];
        if(!ay || ay[x + piece.pos.x] !== 0) return true;
      }
    }
  }
  return false;
}
function rotate(matrix, dir){
  for(let y=0;y<matrix.length;y++) for(let x=0;x<y;x++) [matrix[x][y],matrix[y][x]]=[matrix[y][x],matrix[x][y]];
  if(dir>0) matrix.forEach(row=>row.reverse()); else matrix.reverse();
}
function cloneMatrix(m){ return m.map(r=>r.slice()); }

/* draw helpers */
function drawCell(ctx, x, y, color){
  ctx.fillStyle = color;
  ctx.fillRect(x, y, CELL-1, CELL-1);
  // glow
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.strokeRect(x+0.5, y+0.5, CELL-2, CELL-2);
}
function drawMatrix(matrix, offset, context){
  for(let y=0;y<matrix.length;y++){
    for(let x=0;x<matrix[y].length;x++){
      const val = matrix[y][x];
      if(val){
        context.shadowColor = baseColors[val] || '#88f';
        context.shadowBlur = 18;
        drawCell(context, (x+offset.x)*CELL, (y+offset.y)*CELL, levelColor(val, level));
        context.shadowBlur = 0;
      }
    }
  }
}

/* spawn & queue */
function refillQueue(){
  while(nextQueue.length < 6){
    nextQueue.push(randomPiece());
  }
}
function spawn(){
  refillQueue();
  player.matrix = nextQueue.shift();
  player.pos.y = 0;
  player.pos.x = Math.floor((COLS - player.matrix[0].length)/2);
  player.canHold = true;
  refillQueue();
  if(collide(arena, player)){ gameOver(); }
}

/* hold functionality */
function doHold(){
  if(!player.canHold) return;
  if(!player.hold){
    player.hold = player.matrix.map(r=>r.slice());
    spawn(); // get next
  } else {
    const temp = player.matrix.map(r=>r.slice());
    player.matrix = player.hold.map(r=>r.slice());
    player.hold = temp;
    player.pos.y = 0;
    player.pos.x = Math.floor((COLS - player.matrix[0].length)/2);
    if(collide(arena, player)){ player.matrix = temp; } // rollback if impossible
  }
  player.canHold = false;
  try{ if(sfxHold){ sfxHold.currentTime=0; sfxHold.play(); } }catch(e){}
}

/* sweep lines */
function sweepLines(){
  let rowCount = 0;
  outer: for(let y = arena.length - 1; y >= 0; y--){
    for(let x=0;x<arena[y].length;x++){
      if(arena[y][x] === 0) continue outer;
    }
    const row = arena.splice(y,1)[0].fill(0);
    arena.unshift(row);
    createExplosion(y);
    rowCount++;
    y++;
  }
  if(rowCount>0){
    const points = [0,40,100,300,1200];
    score += (points[rowCount] || rowCount*100)*level;
    lines += rowCount;
    level = Math.floor(lines/10) + 1;
    dropInterval = Math.max(80, 1000 - (level-1)*70);
    updateStats();
    try{ sfxClear.currentTime=0; sfxClear.play(); }catch(e){}
  }
  return rowCount;
}

/* game over */
function gameOver(){
  running = false;
  showOverlay('GAME OVER', `Skor: ${score} ‚Äî Tekan Restart untuk main lagi.`);
  // auto save to leaderboard? Not automatically, user must save with name
}

/* update HUD */
function updateStats(){
  document.getElementById('score').innerText = score;
  document.getElementById('level').innerText = level;
  document.getElementById('lines').innerText = lines;
}

/* particle explosion */
function createExplosion(rowY){
  for(let i=0;i<40;i++){
    particles.push({
      x: Math.random() * canvas.width,
      y: rowY * CELL + Math.random()*CELL,
      vx: (Math.random()-0.5)*6,
      vy: (Math.random()-1.5)*6,
      life: Math.random()*60 + 40,
      color: baseColors[Math.ceil(Math.random()*7)]
    });
  }
}
function updateParticles(context){
  particles = particles.filter(p => p.life > 0);
  particles.forEach(p=>{
    p.x += p.vx; p.y += p.vy; p.vy += 0.15; p.life--;
    context.globalAlpha = Math.max(0, Math.min(1, p.life / 80));
    context.fillStyle = p.color;
    context.fillRect(p.x, p.y, 4, 4);
    context.globalAlpha = 1;
  });
}

/* challenge: push random row from bottom */
function maybeChallenge(delta){
  if(!challengeEnabled) return;
  challengeTimer += delta;
  if(challengeTimer > 15000 && level >= 3){
    challengeTimer = 0;
    const newRow = new Array(COLS).fill(0).map(()=>Math.random() < 0.2 ? 0 : Math.ceil(Math.random()*7));
    arena.push(newRow);
    arena.shift();
    // small shake and particles
    createExplosion(ROWS - 2);
  }
}

/* ---------- game loop & draw ---------- */
function draw(){
  // clear canvas
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // background grid effect
  ctx.fillStyle = 'rgba(1,6,12,0.35)';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // draw arena content
  drawMatrix(arena, {x:0,y:0}, ctx);

  // draw player piece
  if(player.matrix) drawMatrix(player.matrix, player.pos, ctx);

  // update particles
  updateParticles(ctx);

  // next & hold draw
  nextCtx.clearRect(0,0,nextCan.width,nextCan.height);
  holdCtx.clearRect(0,0,holdCan.width,holdCan.height);
  if(nextQueue[0]) drawMini(nextCtx, nextQueue[0]);
  if(player.hold) drawMini(holdCtx, player.hold);
}

/* draw small preview (center) */
function drawMini(context, matrix){
  context.save();
  context.clearRect(0,0,context.canvas.width,context.canvas.height);
  const cell = 28;
  const mw = matrix[0].length;
  const mh = matrix.length;
  const offsetX = Math.floor((4 - mw)/2);
  const offsetY = Math.floor((4 - mh)/2);
  drawMatrix(matrix, {x:offsetX, y:offsetY}, context);
  context.restore();
}

/* main animation loop */
function update(time = 0){
  if(!running) return;
  if(paused){ lastTime = time; requestAnimationFrame(update); return; }
  const delta = time - lastTime;
  lastTime = time;
  dropCounter += delta;
  maybeChallenge(delta);

  if(dropCounter > dropInterval){
    player.pos.y++;
    if(collide(arena, player)){
      player.pos.y--;
      merge(arena, player);
      sweepLines();
      spawn();
    }
    dropCounter = 0;
  }

  draw();
  requestAnimationFrame(update);
}

/* ---------- input & UI ---------- */
function playerMove(dir){
  player.pos.x += dir;
  if(collide(arena, player)) player.pos.x -= dir;
}
function playerRotate(dir){
  rotate(player.matrix, dir);
  if(collide(arena, player)) {
    // try kick
    player.pos.x += 1;
    if(collide(arena, player)) player.pos.x -= 2;
    if(collide(arena, player)) { // revert
      player.pos.x += 1;
      rotate(player.matrix, -dir);
    }
  }
}
function playerDropHard(){
  while(!collide(arena, player)) player.pos.y++;
  player.pos.y--;
  merge(arena, player);
  sweepLines();
  spawn();
  dropCounter = 0;
}
function playerSoftDrop(){ player.pos.y++; if(collide(arena, player)){ player.pos.y--; merge(arena, player); sweepLines(); spawn(); } dropCounter = 0; }

/* keyboard */
let turboActive = false;
window.addEventListener('keydown', (e)=>{
  if(!running) return;
  if(e.key === 'ArrowLeft'){ playerMove(-1); renderOnce(); }
  else if(e.key === 'ArrowRight'){ playerMove(1); renderOnce(); }
  else if(e.key === 'ArrowUp'){ playerRotate(1); renderOnce(); }
  else if(e.key === 'ArrowDown'){ playerSoftDrop(); renderOnce(); }
  else if(e.code === 'Space'){ e.preventDefault(); playerDropHard(); renderOnce(); }
  else if(e.key === 'Shift'){ turboActive = true; dropCounter = dropInterval; }
  else if(e.key.toLowerCase() === 'p'){ paused = !paused; document.getElementById('btn-pause').innerText = paused ? '‚ñ∂ Resume' : '‚è∏ Pause'; }
  else if(e.key.toLowerCase() === 'c'){ doHold(); renderOnce(); }
});
window.addEventListener('keyup', (e)=>{
  if(e.key === 'Shift'){ turboActive = false; }
});

/* quick UI buttons */
document.getElementById('btn-pause').addEventListener('click', ()=>{
  paused = !paused;
  document.getElementById('btn-pause').innerText = paused ? '‚ñ∂ Resume' : '‚è∏ Pause';
});
document.getElementById('btn-hold').addEventListener('click', ()=>{ doHold(); renderOnce(); });
document.getElementById('btn-restart-header').addEventListener('click', ()=>{ restart(); });
document.getElementById('btn-restart-header').addEventListener('dblclick', ()=>{ // dblclick to clear leaderboard quickly
  localStorage.removeItem('tetris3d_leaderboard');
  renderLeaderboard();
});
document.getElementById('btn-music').addEventListener('click', ()=>{
  if(!music) initAudio();
  if(music.paused) { music.volume = parseFloat(volumeControl.value); music.play(); document.getElementById('btn-music').innerText = 'üîä Music'; }
  else { music.pause(); document.getElementById('btn-music').innerText = 'üéµ Music'; }
});

/* volume control */
volumeControl.addEventListener('input', ()=>{
  const v = parseFloat(volumeControl.value);
  if(music) music.volume = v;
  [sfxClear, sfxHold, sfxLock].forEach(s => { if(s) s.volume = v; });
});

/* challenge toggle */
document.getElementById('btn-toggle-challenge').addEventListener('click', ()=>{
  challengeEnabled = !challengeEnabled;
  document.getElementById('btn-toggle-challenge').innerText = challengeEnabled ? 'Challenge ON' : 'Toggle Challenge';
});

/* screenshot */
document.getElementById('btn-screenshot').addEventListener('click', ()=>{
  const data = canvas.toDataURL('image/png');
  const w = window.open('');
  w.document.write(`<img src="${data}" style="max-width:100%"/>`);
});

/* help modal */
document.getElementById('btn-help').addEventListener('click', ()=>{ document.getElementById('helpModal').style.display='block'; });
document.getElementById('helpClose').addEventListener('click', ()=>{ document.getElementById('helpModal').style.display='none'; });

/* save score to leaderboard */
function getLeaderboard(){
  try{
    return JSON.parse(localStorage.getItem('tetris3d_leaderboard') || '[]');
  }catch(e){ return []; }
}
function saveLeaderboardEntry(name, sc){
  const lb = getLeaderboard();
  lb.push({name: name || 'Guest', score: sc, ts: Date.now()});
  lb.sort((a,b)=>b.score - a.score);
  localStorage.setItem('tetris3d_leaderboard', JSON.stringify(lb.slice(0,10)));
  renderLeaderboard();
}
document.getElementById('btn-save').addEventListener('click', ()=>{
  const name = document.getElementById('playerName').value.trim().slice(0,12) || 'Guest';
  saveLeaderboardEntry(name, score);
});

/* render leaderboard */
function renderLeaderboard(){
  const container = document.getElementById('leaderboard');
  container.innerHTML = '';
  const lb = getLeaderboard();
  if(lb.length === 0){ container.innerHTML = '<div class="small" style="opacity:0.8">Belum ada skor tersimpan.</div>'; return; }
  lb.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'leaderboard-item';
    div.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div style="width:30px;height:30px;border-radius:6px;background:linear-gradient(180deg,rgba(77,227,255,0.1),rgba(139,92,255,0.08));display:flex;align-items:center;justify-content:center;font-weight:700">${idx+1}</div><div style="min-width:100px">${item.name}</div></div><div style="font-weight:700">${item.score}</div>`;
    container.appendChild(div);
  });
}
document.getElementById('btn-clear-lb').addEventListener('click', ()=>{
  localStorage.removeItem('tetris3d_leaderboard');
  renderLeaderboard();
});

/* overlay */
function showOverlay(title, msg){
  paused = true;
  const modal = document.getElementById('helpModal');
  modal.style.display = 'block';
  modal.querySelector('h3').innerText = title;
  modal.querySelector('div').innerHTML = `<div style="font-size:13px;color:var(--muted)">${msg}</div>`;
  const close = document.getElementById('helpClose');
  close.innerText = 'Tutup';
}
function hideOverlay(){ document.getElementById('helpModal').style.display='none'; }

/* restart */
function restart(){
  arena = createMatrix(COLS, ROWS);
  player = { pos:{x:0,y:0}, matrix:null, hold:null, canHold:true };
  nextQueue = [];
  refillQueue();
  score = 0; lines = 0; level = 1; dropInterval = 1000; running = true; paused = false; particles = [];
  updateStats(); spawn();
  renderLeaderboard();
  if(music && music.paused){ /* keep paused unless user toggles */ }
  requestAnimationFrame(update);
}

/* initial setup */
refillQueue();
spawn();
updateStats();
renderLeaderboard();

/* small render once helper */
function renderOnce(){ draw(); }

/* ---------- starfield background (parallax + moving) ---------- */
const stars = [];
function initStars(){
  stars.length = 0;
  const w = bgCanvas.width, h = bgCanvas.height;
  for(let i=0;i<220;i++){
    stars.push({
      x: Math.random() * w,
      y: Math.random() * h,
      z: Math.random()*1.2 + 0.2,
      size: Math.random()*1.6,
      hue: Math.random()*360
    });
  }
}
function drawStars(){
  bgCtx.clearRect(0,0,bgCanvas.width,bgCanvas.height);
  // subtle gradient
  const g = bgCtx.createLinearGradient(0,0,bgCanvas.width,bgCanvas.height);
  g.addColorStop(0,'rgba(5,8,20,0.7)');
  g.addColorStop(1,'rgba(0,0,0,0.7)');
  bgCtx.fillStyle = g;
  bgCtx.fillRect(0,0,bgCanvas.width,bgCanvas.height);

  stars.forEach(s=>{
    const brightness = 0.6 + 0.4 * Math.sin((Date.now()/1000) + s.x*0.001);
    const sat = 60 + s.z*30;
    bgCtx.fillStyle = `hsla(${s.hue}, ${sat}%, ${30 + s.z*30}%, ${brightness})`;
    bgCtx.beginPath();
    bgCtx.arc(s.x, s.y, s.size * s.z, 0, Math.PI*2);
    bgCtx.fill();
  });

  // moving starfield: shift slightly to create parallax
  const t = Date.now()/1000;
  stars.forEach((s,i)=>{
    s.x += Math.cos(t*0.2 + i) * 0.02 * s.z;
    s.y += Math.sin(t*0.2 + i) * 0.02 * s.z;
    if(s.x < -10) s.x = bgCanvas.width + 10;
    if(s.x > bgCanvas.width + 10) s.x = -10;
    if(s.y < -10) s.y = bgCanvas.height + 10;
    if(s.y > bgCanvas.height + 10) s.y = -10;
  });

  requestAnimationFrame(drawStars);
}
initStars();
drawStars();

/* handle window resize to adjust background canvas size */
window.addEventListener('resize', ()=>{
  bgCanvas.width = document.querySelector('.stage').clientWidth;
  bgCanvas.height = document.querySelector('.stage').clientHeight;
  initStars();
});

/* small tweaks: make mini canvases use same drawMatrix logic */
nextCtx.scale(1,1);
holdCtx.scale(1,1);

/* Start main loop */
requestAnimationFrame(update);

/* expose some helpers for debugging (optional) */
window.__tetris = { restart, arena, player, spawn, refillQueue, createMatrix };
</script>
</body>
</html>
